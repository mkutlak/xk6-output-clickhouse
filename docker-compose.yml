# =============================================================================
# xk6-output-clickhouse — Local Development & CI Environment
# =============================================================================
# Profiles:
#   (default)  — ClickHouse only
#   dev        — ClickHouse + Grafana + interactive k6 runner
#   full       — ClickHouse + Grafana
#   ci / test  — ClickHouse + k6 headless runner + test validator
#   manual     — k6-base (not started directly)
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # ClickHouse — Metrics storage
  # ---------------------------------------------------------------------------
  clickhouse:
    image: clickhouse/clickhouse-server:${CLICKHOUSE_VERSION:-25.12-alpine}
    container_name: xk6-clickhouse
    ports:
      - "${CLICKHOUSE_HTTP_PORT:-8123}:8123"
      - "${CLICKHOUSE_NATIVE_PORT:-9000}:9000"
    environment:
      CLICKHOUSE_DB: ${CLICKHOUSE_DB:-k6}
      CLICKHOUSE_USER: ${CLICKHOUSE_USER:-default}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-password}
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: ${CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT:-1}
      CLICKHOUSE_LOG_LEVEL: ${CLICKHOUSE_LOG_LEVEL:-information}
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - clickhouse_logs:/var/log/clickhouse-server
    healthcheck:
      test: ["CMD-SHELL", "clickhouse-client --query 'SELECT 1' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      - k6-network

  # ---------------------------------------------------------------------------
  # Grafana — Dashboards & visualization
  # ---------------------------------------------------------------------------
  grafana:
    image: grafana/grafana:${GRAFANA_VERSION:-12.3}
    container_name: xk6-grafana
    profiles:
      - dev
      - full
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    environment:
      GF_AUTH_ANONYMOUS_ENABLED: ${GF_AUTH_ANONYMOUS_ENABLED:-true}
      GF_AUTH_ANONYMOUS_ORG_ROLE: ${GF_AUTH_ANONYMOUS_ORG_ROLE:-Admin}
      GF_AUTH_DISABLE_LOGIN_FORM: ${GF_AUTH_DISABLE_LOGIN_FORM:-false}
      GF_SECURITY_ADMIN_USER: ${GF_SECURITY_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GF_SECURITY_ADMIN_PASSWORD:-admin}
      GF_PLUGINS_PREINSTALL: grafana-clickhouse-datasource
    volumes:
      - grafana_data:/var/lib/grafana
      - grafana_provisioning:/etc/grafana/provisioning
    depends_on:
      clickhouse:
        condition: service_healthy
    networks:
      - k6-network

  # ---------------------------------------------------------------------------
  # k6-base — Shared k6 configuration (not started directly)
  # ---------------------------------------------------------------------------
  k6-base:
    build:
      context: .
      dockerfile: Dockerfile
    image: xk6-output-clickhouse:latest
    profiles:
      - manual
    environment:
      K6_OUT: ${K6_OUT:-xk6-clickhouse=clickhouse:9000?database=k6&user=default&password=password&schemaMode=compatible}
      K6_CLICKHOUSE_ADDR: ${K6_CLICKHOUSE_ADDR:-clickhouse:9000}
      K6_CLICKHOUSE_DB: ${K6_CLICKHOUSE_DB:-k6}
      K6_CLICKHOUSE_USER: ${K6_CLICKHOUSE_USER:-default}
      K6_CLICKHOUSE_PASSWORD: ${K6_CLICKHOUSE_PASSWORD:-password}
      K6_CLICKHOUSE_SCHEMA_MODE: ${K6_CLICKHOUSE_SCHEMA_MODE:-compatible}
    depends_on:
      clickhouse:
        condition: service_healthy
    networks:
      - k6-network

  # ---------------------------------------------------------------------------
  # k6-dev — Interactive k6 runner for local development
  # ---------------------------------------------------------------------------
  k6-dev:
    extends:
      service: k6-base
    container_name: xk6-runner-dev
    profiles:
      - dev
    tty: true
    stdin_open: true
    volumes:
      - ./examples:/home/k6/examples:rw
      - ./scripts:/home/k6/scripts:rw
      - k6_results:/home/k6/results
    command: run /home/k6/examples/simple.js

  # ---------------------------------------------------------------------------
  # k6-test — Headless k6 runner for CI pipelines
  # ---------------------------------------------------------------------------
  k6-test:
    extends:
      service: k6-base
    container_name: xk6-runner-test
    profiles:
      - ci
      - test
    restart: "no"
    volumes:
      - ./examples:/home/k6/examples:ro
      - k6_results:/home/k6/results
    command: run --quiet --summary-export /home/k6/results/summary.json /home/k6/examples/simple.js

  # ---------------------------------------------------------------------------
  # test-validator — Validates k6 data landed in ClickHouse
  # ---------------------------------------------------------------------------
  test-validator:
    image: clickhouse/clickhouse-server:${CLICKHOUSE_VERSION:-25.12-alpine}
    container_name: xk6-test-validator
    profiles:
      - ci
      - test
    depends_on:
      k6-test:
        condition: service_completed_successfully
    entrypoint: >
      clickhouse-client
        --host clickhouse
        --user ${CLICKHOUSE_USER:-default}
        --password ${CLICKHOUSE_PASSWORD:-password}
        --database ${CLICKHOUSE_DB:-k6}
        --query "SELECT count() AS row_count FROM samples HAVING row_count > 0"
    restart: "no"
    networks:
      - k6-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  clickhouse_data:
    driver: local
  clickhouse_logs:
    driver: local
  grafana_data:
    driver: local
  grafana_provisioning:
    driver: local
  k6_results:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  k6-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
